#!/bin/bash
###############################################################################
# TRANSERVICA.NET - SCRIPT DE VERIFICACIÓN DE URLs
# Verifica el estado HTTP de todas las URLs problemáticas
###############################################################################
# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color
# Banner
echo ""
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║        TRANSERVICA.NET - VERIFICACIÓN DE URLs               ║"
echo "║        Fecha: $(date +'%Y-%m-%d %H:%M:%S')                        ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo ""
###############################################################################
# URLS QUE DEBEN REDIRIGIR (301)
###############################################################################
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}URLS QUE DEBEN REDIRIGIR (301 o 302)${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""
redirect_urls=(
    "https://transervica.net/category/movimientos/"
    "https://transervica.net/about-us-slider-2-bg-jpg/"
    "https://transervica.net/11/"
    "https://transervica.net/?_escaped_fragment_="
)
redirect_count_ok=0
redirect_count_fail=0
for url in "${redirect_urls[@]}"; do
    # Obtener código HTTP
    http_code=$(curl -s -o /dev/null -w "%{http_code}" -L "$url")
    redirect_url=$(curl -s -o /dev/null -w "%{redirect_url}" "$url")
    
    # Verificar si es redirect
    if [[ "$http_code" == "301" ]] || [[ "$http_code" == "302" ]]; then
        echo -e "${GREEN}✅ $url${NC}"
        echo -e "   └─ HTTP $http_code → $redirect_url"
        ((redirect_count_ok++))
    else
        echo -e "${RED}❌ $url${NC}"
        echo -e "   └─ HTTP $http_code (ESPERADO: 301 o 302)"
        ((redirect_count_fail++))
    fi
    echo ""
done
echo -e "Resumen Redirects: ${GREEN}$redirect_count_ok OK${NC} | ${RED}$redirect_count_fail FALLOS${NC}"
echo ""
###############################################################################
# URLS QUE DEBEN ESTAR ACTIVAS (200)
###############################################################################
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}URLS QUE DEBEN ESTAR ACTIVAS (200)${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""
active_urls=(
    "https://transervica.net/"
    "https://transervica.net/servicios/"
    "https://transervica.net/services/izamiento-carga/"
    "https://transervica.net/contacto/"
    "https://transervica.net/transporte-terrestre-y-descarga-de-plantas-compresoras/"
)
active_count_ok=0
active_count_fail=0
for url in "${active_urls[@]}"; do
    # Obtener código HTTP (con timeout de 10s)
    http_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$url")
    
    if [[ "$http_code" == "200" ]]; then
        echo -e "${GREEN}✅ $url${NC}"
        echo -e "   └─ HTTP $http_code"
        ((active_count_ok++))
    else
        echo -e "${RED}❌ $url${NC}"
        echo -e "   └─ HTTP $http_code (ESPERADO: 200)"
        ((active_count_fail++))
    fi
    echo ""
done
echo -e "Resumen Activas: ${GREEN}$active_count_ok OK${NC} | ${RED}$active_count_fail FALLOS${NC}"
echo ""
###############################################################################
# VERIFICACIÓN DE ROBOTS.TXT
###############################################################################
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}VERIFICACIÓN DE ROBOTS.TXT${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""
robots_url="https://transervica.net/robots.txt"
http_code=$(curl -s -o /dev/null -w "%{http_code}" "$robots_url")
if [[ "$http_code" == "200" ]]; then
    echo -e "${GREEN}✅ robots.txt accesible${NC}"
    echo -e "   └─ URL: $robots_url"
    echo ""
    echo "Contenido (primeras 10 líneas):"
    curl -s "$robots_url" | head -n 10
else
    echo -e "${RED}❌ robots.txt no accesible${NC}"
    echo -e "   └─ HTTP $http_code"
fi
echo ""
###############################################################################
# VERIFICACIÓN DE SITEMAP
###############################################################################
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}VERIFICACIÓN DE SITEMAP${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""
sitemap_urls=(
    "https://transervica.net/sitemap.xml"
    "https://transervica.net/sitemap_index.xml"
    "https://transervica.net/wp-sitemap.xml"
)
sitemap_found=false
for sitemap_url in "${sitemap_urls[@]}"; do
    http_code=$(curl -s -o /dev/null -w "%{http_code}" "$sitemap_url")
    
    if [[ "$http_code" == "200" ]]; then
        echo -e "${GREEN}✅ Sitemap encontrado: $sitemap_url${NC}"
        
        # Contar URLs en el sitemap
        url_count=$(curl -s "$sitemap_url" | grep -o "<loc>" | wc -l)
        echo -e "   └─ URLs en sitemap: $url_count"
        sitemap_found=true
        break
    fi
done
if [ "$sitemap_found" = false ]; then
    echo -e "${YELLOW}⚠️  Ningún sitemap encontrado${NC}"
    echo "   Sitemap URLs probadas:"
    for sitemap_url in "${sitemap_urls[@]}"; do
        echo "   - $sitemap_url"
    done
fi
echo ""
###############################################################################
# VERIFICACIÓN DE META ROBOTS EN URLs ACTIVAS
###############################################################################
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo -e "${BLUE}VERIFICACIÓN DE META ROBOTS${NC}"
echo -e "${BLUE}═══════════════════════════════════════════════════════════${NC}"
echo ""
for url in "${active_urls[@]}"; do
    echo "Verificando: $url"
    
    # Buscar meta robots
    noindex=$(curl -s "$url" | grep -i "noindex" | head -n 1)
    
    if [ -n "$noindex" ]; then
        echo -e "${YELLOW}⚠️  NOINDEX encontrado:${NC}"
        echo "   $noindex"
    else
        echo -e "${GREEN}✅ Sin NOINDEX (indexable)${NC}"
    fi
    
    echo ""
done
###############################################################################
# RESUMEN FINAL
###############################################################################
echo ""
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║                     RESUMEN FINAL                            ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo ""
total_tests=$((redirect_count_ok + redirect_count_fail + active_count_ok + active_count_fail))
total_ok=$((redirect_count_ok + active_count_ok))
total_fail=$((redirect_count_fail + active_count_fail))
echo "Total de tests: $total_tests"
echo -e "Tests exitosos: ${GREEN}$total_ok${NC}"
echo -e "Tests fallidos: ${RED}$total_fail${NC}"
echo ""
if [ "$total_fail" -eq 0 ]; then
    echo -e "${GREEN}╔═══════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║  ✅ TODOS LOS TESTS PASARON EXITOSAMENTE ✅      ║${NC}"
    echo -e "${GREEN}╚═══════════════════════════════════════════════════╝${NC}"
    exit 0
else
    echo -e "${RED}╔═══════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║  ⚠️  HAY PROBLEMAS QUE REQUIEREN ATENCIÓN  ⚠️   ║${NC}"
    echo -e "${RED}╚═══════════════════════════════════════════════════╝${NC}"
    echo ""
    echo "Próximos pasos:"
    echo "1. Revisar URLs que fallaron"
    echo "2. Implementar fixes en functions.php o .htaccess"
    echo "3. Re-ejecutar este script para validar"
    exit 1
fi
